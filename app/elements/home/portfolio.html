<dom-module id="my-portfolio">
    <template>
        <style>
            :host {
                display: block;
                background: var(--dark-primary-color);
            }
            .contact{
                margin-bottom: 0px;
            }

            .title-text {
                color: var(--accent-color);
            }

            paper-card {
                margin: 10px 0px;
                background-color: var(--text-primary-color);
            }

            h1 {
                margin: 0px;
            }
            .row {
                margin-bottom: 0px;
            }

            .portfolio {
                color: var(--accent-color);
            }

            .site {
                opacity: 0;
                /*display: hidden;*/
            }
        </style>
        <div class="row container">
            <h1 class="portfolio">Portfolio</h1>
            <template is="dom-repeat" items="{{profile.portfolio}}" as="site">
            <div class="col s12">
                <paper-card id="site-{{index}}" class="site" elevation="5">
                    <div class="header style-scope paper-card center">
                        <div class="title-text style-scope paper-card center">{{site.name}}</div>
                    </div>
                    <div class="card-content">
                        <a href="{{site.site}}"><img class="responsive-img" src="{{site.image}}"></a>
                        <p>{{site.description}}</p>
                    </div>
                </paper-card>
            </div>
            </template>
        </div>
        <iron-signals on-iron-signal-scroll="scrolled"></iron-signals>
    </template>
    <script>
        Polymer({
            is: 'my-portfolio',
            behaviors: [
                Polymer.NeonAnimationRunnerBehavior
            ],
            listeners: {
                'scroll': 'scrolled',
                'neon-animation-finish': '_onNeonAnimationFinish'
            },
            properties: {
                profile: {
                    observer: 'profileReady'
                },
                started: false,
                allDisplayed: false,
                animationConfig: {
                    value: function() {
                        return {};
                    }
                }
            },
            _onNeonAnimationFinish: function (e) {
                this.animations[e.detail] = true;
            },
            scrolled: function (e) {
                if (this.allDisplayed) {
                    return;
                }

                if (e.detail.scrollTop >= 800 ||
                    (e.detail.clientWidth < 800 && e.detail.scrollTop >= 1000)
                    ) {
                    if (!this.started) {
                        this.start(e.detail.scrollTop);
                    }
                    this.started = true;
                }

                if (e.detail.scrollTop >= 1100 ||
                    (e.detail.clientWidth < 800 && e.detail.scrollTop >= 1300)
                    ) {
                    this.playNext(e.detail.scrollTop, e.detail.clientWidth);
                }
            },
            start: function () {
                this.animations = [];
                for (var i = 0; i < this.profile.portfolio.length; i++) {
                    this.animations.push(false);
                    this.animationConfig['site-' + i] = {
                        name: this.profile.portfolio[i].animation,
                        node: document.querySelector('#site-' + i),
                    };
                }
            },
            playNext: function (scroll, width) {
                var indexToPlay = -1,
                    surplus = width < 800 && 400 || 0;


                if (scroll >= (1100 - surplus) && scroll < (1800 - surplus)) {
                    indexToPlay = 0;
                }

                if (scroll >= (1800 - surplus) && scroll < (2500 - surplus)) {
                    indexToPlay = 1;
                }

                if (scroll >= (2400 - surplus)) {
                    indexToPlay = 2;
                    this.allDisplayed = true;
                }

                for (var i = 0; i <= indexToPlay; i++) {
                    if (!this.animations[i]) {
                        document.querySelector('#site-' + i).style.opacity = 1;
                        this.playAnimation('site-' + i, i);
                    }
                }

            },
        });
    </script>
</dom-module>