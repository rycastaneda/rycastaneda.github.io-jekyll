<dom-module id="my-skill">
    <template>
        <style>
            :host {
                display: block;
                background-color: var(--primary-background-color);
            }

            paper-progress {
                width: 100%;
            }

            paper-card {
                background-color: var(--text-primary-color);
            }

            .skill {
                opacity: 0;
                margin: 10px 0;
            }

            .rating {
                color: var(--secondary-text-color);
                font-size: 35px;
            }
        </style>
        <div class="section">
            <div class="row container">
                <template is="dom-repeat" items="{{profile.skills}}" as="skill">
                    <paper-card class="col s12 skill" id="skill-{{index}}" elevation="3">
                        <div class="header style-scope paper-card">
                            <div class="title-text left style-scope paper-card">{{skill.skill}}</div>
                            <div class="title-text right style-scope paper-card"><span class="rating">{{skill.rating}}</span> / 10</div>
                        </div>
                        <div class="card-content">
                            <paper-progress id="progress-{{index}}" value="{{skill.rating}}" max="10" class=""></paper-progress><br>
                        </div>
                    </paper-card>
                </template>
            </div>
        </div>
        <iron-signals on-iron-signal-scroll="scrolled"></iron-signals>
    </template>
    <script>
        Polymer({
            is: 'my-skill',
            behaviors: [
                Polymer.NeonAnimationRunnerBehavior
            ],
            listeners: {
                'scroll': 'scrolled',
                'neon-animation-finish': '_onNeonAnimationFinish'
            },
            properties: {
                profile: {
                    observer: 'profileReady'
                },
                started: false,
                allDisplayed: false,
                animationConfig: {
                    value: function() {
                        return {};
                    }
                }
            },
            scrolled: function (e) {
                if (this.allDisplayed) {
                    return;
                }

                if (e.detail.scrollTop > 3000 ||
                    (e.detail.clientWidth < 800 && e.detail.scrollTop >= 2000)
                    ) {
                    if (!this.started) {
                        this.start(e.detail.scrollTop);
                    }
                    this.started = true;
                }

                if (e.detail.scrollTop >= 3300 ||
                    (e.detail.clientWidth < 800 && e.detail.scrollTop >= 26)
                    ) {
                    this.playNext(e.detail.scrollTop, e.detail.clientWidth);
                }
            },
            profileReady: function () {
                this.ratings = this.profile.skills.map(function (s) {
                    return s.rating;
                });

                for (var i = 0; i < this.profile.skills.length; i++) {
                    this.profile.skills[i].rating = 0;
                }
            },
            _onNeonAnimationFinish: function (e) {
                document.querySelector('#skill-' + e.detail).opacity = 1;
                this.nextProgress(e.detail);
            },
            nextProgress: function (idx) {
                if (this.profile.skills[idx].rating < this.ratings[idx]) {
                    this.set('profile.skills.' + idx + '.rating', this.profile.skills[idx].rating += 1);
                }
                requestAnimationFrame(this.nextProgress.bind(this, idx));
            },
            playNext: function (scroll, width) {
                var surplus = width < 800 && 6 || 0,
                    indexToPlay = Math.floor(scroll / 100 - (32 - surplus)),
                    i = 0,
                    skillsToPlay;

                if (indexToPlay > this.profile.skills.length) {
                    skillsToPlay = this.profile.skills.length - 1;
                    this.allDisplayed = true;
                } else if (indexToPlay < this.profile.skills.length) {
                    skillsToPlay = indexToPlay;
                }

                for (i = 0; i <= skillsToPlay; i++) {
                    if (!this.profile.skills[i].rating) {
                        this.playAnimation('skill-' + i, i);
                    }
                }

                if (this.profile.skills[skillsToPlay] && !this.profile.skills[skillsToPlay].rating) {
                    this.playAnimation('skill-' + skillsToPlay, skillsToPlay);
                }

            },
            start: function () {
                for (var i = 0; i < this.profile.skills.length; i++) {
                    this.animationConfig['skill-' + i] = {
                        name: 'fade-in-animation',
                        node: document.querySelector('#skill-' + i),
                        // timing: {delay: 1000}
                    };
                }
            }
        });
    </script>
</dom-module>